---
title: "Country Analysis Template"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: journal
---

## Background

The overall goal of this project is to reduce morbidity and mortality of sick children attending primary care facilities while supporting the rational and efficient use of diagnostics and medicines by healthcare providers. This study is focused on generating evidence for pulse oximetry and clinical decision support algorithms (CDSAs) in primary care. To determine the performance of the multimodal PO devices under investigation in this study, a cross-sectional diagnostic accuracy study will compare the index multimodal PO devices to an accepted reference standard.

The primary objective of this study is to determine the performance of available multimodal PO devices compared to an accepted reference standard by primary care providers assessing chidlren 0-59 months seeking care at the primary care level. Reference standards for the different clinical measurements include: Masimo Rad97 patient monitor (SpO2, PR), video derived annotated respiratory rate (RR), and digital infrared thermometer (temp). Secondary objectives include determining if any variability in performance is detected by age category or skin pigmentation and assessing interrater reliability.

## Using this document

(agreed upon conventions)

```{r setup, include=FALSE}
rm(list = ls())
# install these packages if not already on your computer
library(plyr)
library(dplyr)
library(tableone)
library(kableExtra)
library(BlandAltmanLeh)
library(irr)
library(reshape2)
library(ggplot2)

# Read in (cleaned) data using file choose
filename <- file.choose()
df_og <- read.csv(filename)
df_og <- df_og %>% select(-c("X"))

# Define country and subset
COUNTRY <- "Kenya" # Kenya, Tanzania, India -- USER INPUT HERE
df_og <- subset(df_og, df_og$country==COUNTRY)

# Define thresholds for hypoxia, fast breathing, tachycardia, and fever for all index and reference measurements (for confusion matrices in section 5) -- should be binary indicators for above/below threshold

# Create a df for each device -- note: any variable formatting (e.g., converting to factors) or additional variable creation should happen prior to creating these little dataframes
df_radg <- subset(df_og, index_device_name=="Rad-G Temp (Masimo)")
df_radg_cat1 <- subset(df_radg, age_cat=="0-1 month")
df_radg_cat2 <- subset(df_radg, age_cat=="2-11 months")
df_radg_cat3 <- subset(df_radg, age_cat=="12-59 months")

df_bio <- subset(df_og, index_device_name=="m800 (Biolight)")
df_bio_cat1 <- subset(df_bio, age_cat=="0-1 month")
df_bio_cat2 <- subset(df_bio, age_cat=="2-11 months")
df_bio_cat3 <- subset(df_bio, age_cat=="12-59 months")

df_neo <- subset(df_og, index_device_name=="NeoGuard (Neopenda)")
df_neo_cat1 <- subset(df_neo, age_cat=="0-1 month")
df_neo_cat2 <- subset(df_neo, age_cat=="2-11 months")
df_neo_cat3 <- subset(df_neo, age_cat=="12-59 months")

df_onyx <- subset(df_og, index_device_name=="Onyx PO+RR (Nonin)")
df_onyx_cat3 <- subset(df_onyx, age_cat=="12-59 months")

df_scan <- subset(df_og, index_device_name=="Scanbo v8 (Scanbo)")
df_scan_cat3 <- subset(df_scan, age_cat=="12-59 months")
```

This report contains data from *`r COUNTRY`*.

# Section 1: Participant Characteristics {.tabset}
Leila
Table 1: Participant Characteristics Overall and by Facility
```{r echo=FALSE, include=FALSE}
# consider using the CreateTableOne function from the tableone package, example:
## Define row labels (optional): t1lab <- c("N", "Age category", "Sex = Male (%)", ...)
## Define all variables: vars <- c("age_cat2", "sex", ...)
## Define the variables you want it to treat as factors (useful if they could be perceived as continuous): fvar <- c("age_cat2", sex", ...)

## create the tableone object: out1 <- CreateTableOne(vars = vars,
#                                       factorVars = fvar,
#                                       strata = "health_facility",
#                                       data = df)
# print as table: t1 <- print(out1)
# assign rownames defined above (optional - would recommend only doing this once the rows are set so you know what each one is): rownames(t1) <- c(t1lab)

# kable formatting if you want to get fancy: 
#  t1 <- kable(out1) %>%
#  kable_styling(position = "center") %>%
#  add_indent(c(3:5))

#`r t1`
```

```{r}

# @ Leila and team - would recommend using the cleaned check box variables (have been added to the codebook), also just an fyi that you don't need to explicitly create factored variables for the CreateTableOne to treat them as categorical, as long as they're included in your factorVars list they'll be handled as categorical even if they're numeric

## Convert categorical variables into factors

df_og$age_cat <- factor(df_og$age_cat,levels = c(1,2,3),
                        labels = c("0-1 month","2-11 months","12-59 months"))
df_og$sex <- factor(df_og$sex, levels = c(0,1),
                    labels = c("Male","Female"))
df_og$cg_relationship <- factor(df_og$cg_relationship, levels = c(1,2,3,4,5,6,7,8,9,10),
                                labels = c("Mother and Father","Mother and Grandmother","Mother only",
                                           "Father only", "Grandmother only","Grandfather only","Sibling",
                                           "Other family member","Community member", "Other"))
df_og$visit_rsn_illness <- factor(df_og$visit_rsn_illness,levels = c(0,1), 
                                 labels =c("FALSE","TRUE")) #Visited due to illness
df_og$visit_reason___2 <- factor(df_og$visit_reason___2,levels = c(0,1),
                                 labels =c("FALSE","TRUE")) #Visited due to immunization
df_og$visit_reason___3 <- factor(df_og$visit_reason___3,levels = c(0,1),
                                 labels =c("FALSE","TRUE")) #Visited due to routine monitoring
df_og$visit_reason___4 <- factor(df_og$visit_reason___4,levels = c(0,1),
                                 labels =c("FALSE","TRUE")) #Visited due to trauma
df_og$visit_reason___5 <- factor(df_og$visit_reason___5,levels = c(0,1),
                                 labels =c("FALSE","TRUE")) #Visited due to admission at the facility
df_og$visit_reason_ill_sxs___1 <- factor(df_og$visit_reason_ill_sxs___1,levels = c(0,1),
                                         labels =c("FALSE","TRUE")) #Cough
df_og$visit_reason_ill_sxs___2 <- factor(df_og$visit_reason_ill_sxs___2,levels = c(0,1),
                                         labels =c("FALSE","TRUE")) #Difficulty/rapid breathing
df_og$visit_reason_ill_sxs___3 <- factor(df_og$visit_reason_ill_sxs___3,levels = c(0,1),
                                         labels =c("FALSE","TRUE")) #Fever
df_og$visit_reason_ill_sxs___4 <- factor(df_og$visit_reason_ill_sxs___4,levels = c(0,1),
                                         labels =c("FALSE","TRUE")) #Diarrhea
df_og$visit_reason_ill_sxs___5 <- factor(df_og$visit_reason_ill_sxs___5,levels = c(0,1),
                                         labels =c("FALSE","TRUE")) #Vomiting
df_og$visit_reason_ill_sxs___6 <- factor(df_og$visit_reason_ill_sxs___6,levels = c(0,1),
                                         labels =c("FALSE","TRUE")) ##Other
df_og$received_dx <- factor(df_og$received_dx,levels = c(0,1),
                            labels = c("FALSE","TRUE")) #was a diagnosis received
df_og$reported_dx___1 <- factor(df_og$reported_dx___1,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Dehydration
df_og$reported_dx___2 <- factor(df_og$reported_dx___2,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Respiratory
df_og$reported_dx___3 <- factor(df_og$reported_dx___3,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Digestive
df_og$reported_dx___4 <- factor(df_og$reported_dx___4,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Malaria
df_og$reported_dx___5 <- factor(df_og$reported_dx___5,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Fever
df_og$reported_dx___6 <- factor(df_og$reported_dx___6,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Measles
df_og$reported_dx___7 <- factor(df_og$reported_dx___7,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Ear infection
df_og$reported_dx___8 <- factor(df_og$reported_dx___8,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Throat infection
df_og$reported_dx___9 <- factor(df_og$reported_dx___9,levels = c(0,1),
                                labels =c("FALSE","TRUE")) #Other
df_og$recieved_txt <- factor(df_og$recieved_txt, levels = c(0,1),
                             labels = c("FALSE", "TRUE"))
df_og$reported_tx___1 <- factor(df_og$reported_tx___1, levels = c(0, 1),
                                labels = c("FALSE", "TRUE"))
df_og$reported_tx___2 <- factor(df_og$reported_tx___2, levels = c(0, 1),
                                labels = c("FALSE", "TRUE"))
df_og$reported_tx___3 <- factor(df_og$reported_tx___3, levels = c(0, 1),
                                labels = c("FALSE", "TRUE"))
df_og$reported_tx___4 <- factor(df_og$reported_tx___4, levels = c(0, 1),
                                labels = c("FALSE", "TRUE"))
df_og$reported_tx___5 <- factor(df_og$reported_tx___5, levels = c(0, 1),
                                labels = c("FALSE", "TRUE"))

## Create an object "cat_var" with all categorical variables

cat_var <- c("age_cat", "sex","cg_relationship", 
         "visit_rsn_illness", "visit_reason___2", "visit_reason___3", "visit_reason___4", "visit_reason___5",
         "visit_reason_ill_sxs___1", "visit_reason_ill_sxs___2", "visit_reason_ill_sxs___3",
         "visit_reason_ill_sxs___4", "visit_reason_ill_sxs___5", "visit_reason_ill_sxs___6",
         "received_dx", "reported_dx___1", "reported_dx___2", "reported_dx___3", "reported_dx___4",
         "reported_dx___5", "reported_dx___6", "reported_dx___7", "reported_dx___8", "reported_dx___9",
         "recieved_txt", "reported_tx___1", "reported_tx___2", "reported_tx___3", "reported_tx___4",
         "reported_tx___5")

## Continuous variables

## Create a dataframe 'ref_values' with all our reference measurements (excluding RR awaiting video annotation)
ref_values <- df_og %>% 
  select(m1_ref_sp02, m2_ref_sp02, m3_ref_sp02,
         m1_ref_pr, m2_ref_pr, m3_ref_pr,
         m1_therm_skin_temp, m2_therm_skin_temp, m3_therm_skin_temp)

## Create objects with the mean values of our reference measurements

mean_ref_sp02 <- rowMeans(ref_values [, c("m1_ref_sp02", "m2_ref_sp02", "m3_ref_sp02")],
                                  na.rm = TRUE)

mean_ref_pr <- rowMeans(ref_values [, c("m1_ref_pr", "m2_ref_pr", "m3_ref_pr")],
                                  na.rm = TRUE)

mean_ref_temp <- rowMeans(ref_values [, c("m1_therm_skin_temp", "m2_therm_skin_temp",
                                          "m3_therm_skin_temp")], 
                          na.rm = TRUE)

## Create a dataframe 'mean_ref_values' containing the mean values computed above

mean_ref_values <- data.frame(mean_ref_pr, mean_ref_sp02, mean_ref_temp)

## Summarise 

cont <- summary(mean_ref_values)

## Create an object "myVars" which contains all the variables we want in our table1 (both categorical and continuous)
## Not yet included SpO2, PR, RR, Temp

myVars <- c("age_cat", "sex","cg_relationship", 
         "visit_rsn_illness", "visit_reason___2", "visit_reason___3", "visit_reason___4", "visit_reason___5",
         "visit_reason_ill_sxs___1", "visit_reason_ill_sxs___2", "visit_reason_ill_sxs___3",
         "visit_reason_ill_sxs___4", "visit_reason_ill_sxs___5", "visit_reason_ill_sxs___6",
         "received_dx", "reported_dx___1", "reported_dx___2", "reported_dx___3", "reported_dx___4",
         "reported_dx___5", "reported_dx___6", "reported_dx___7", "reported_dx___8", "reported_dx___9",
         "recieved_txt", "reported_tx___1", "reported_tx___2", "reported_tx___3", "reported_tx___4",
         "reported_tx___5", "height", "weight", "muac", "hemocue_hb")

## Use CreateTableOne function to generate output

CreateTableOne(vars = myVars,
               data = df_og,
               factorVars = cat_var,
               strata = "facility_name")
```


# Section 2: Measurement Characteristics & Precision {.tabset}
Leila

## Reference
```{r echo=FALSE, include=FALSE}

```

## Rad-G Temp (Masimo)


## m800 (Biolight)


## NeoGuard (Neopenda)


## Onyx PO+RR (Nonin)


## Scanbo v8 (Scanbo)


# Section 3: Bland Altman Plots {.tabset}
Anmol

-- RG Note: let's see if we can find a way to get M1, M2, and M3 all on the same plot and perhaps distinguish them by color?
Example code:
```{r}
# @Anmol - I had a couple ideas of things to try for the plots... 1) I think we will need the data structured differently to make this type of grouping work - see sample code below using the melt function from the reshape2 package and 2) I think if we switch the graphical system to base instead of ggplot we can make it work -- see sample code in next chunk
## tdf = test data frame; m_tdf = melted test data frame (would recommend more intuitive naming) -- let me know if you'd like some help building out these different mini-df's, I know it's a lot of coding

tdf <- df_radg_cat1 %>% select(ppt_id, colnames(df_radg_cat1[grepl("+_o2", names(df_radg_cat1))]))
m_tdf <- melt(tdf)
m_tdf$grp <- substr(m_tdf$variable, start = 1, stop = 2)
m_tdf$mes <- substr(m_tdf$variable, start = 4, stop = nchar(as.character(m_tdf$variable)))
m_tdf <- m_tdf %>% select(-c(variable))
m_tdf_i <- subset(m_tdf, grepl("index", m_tdf$mes))
names(m_tdf_i)[2] <- paste(m_tdf_i$mes)
m_tdf_i <- m_tdf_i %>% select(-c(mes))
m_tdf_r <- subset(m_tdf, grepl("ref", m_tdf$mes))
names(m_tdf_r)[2] <- paste(m_tdf_r$mes)
m_tdf_r <- m_tdf_r %>% select(-c(mes))
m_tdf <- left_join(m_tdf_i, m_tdf_r, by = c("ppt_id", "grp"))
m_tdf$grp <- factor(m_tdf$grp)

```

```{r}
bland.altman.plot(m_tdf$ref_o2, m_tdf$index_o2, graph.sys = "base", xlab = "Means", ylab = "Differences", main = "Bland-Altman Plot: Rad-G O2 (0-1 month)", col = c("black", "blue", "green"), pch=19)
legend("topleft", legend = levels(m_tdf$grp), col = c("black", "blue", "green"), pch = 19)
```

## Rad-G Temp (Masimo) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Temperature

### Oxygen

### Profusion Index

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

## m800 (Biolight) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Oxygen

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

## NeoGuard (Neopenda) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Temperature

### Oxygen

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

## Onyx PO+RR (Nonin) {.tabset}
```{r echo=FALSE, include=FALSE}
df <- df_onyx
```

## Scanbo v8 (Scanbo) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Temperature

### Oxygen

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

# Section 4: Intraclass Correlation Coefficients {.tabset}
Reporting information:
- Model: Two-way mixed effects [NOTE: no functional difference between 2-way random and mixed effects...seems the difference is more conceptual than mathematical but should confirm w/Laina]
-- Justification: Repeated measurements cannot be considered random samples.
- Type: Single measurement
-- Justification: In clinical practice, a single measurement rather than the mean of multiple measurements is considered as the unit of analysis.
- Definition: Absolute agreement
-- Justification: This is the only appropriate definition for a test-retest analysis, as the device of interest would be meaningless without agreement between repeated measures.

How to interpret the ICC:
-	<0.5: Poor reliability
-	0.5<0.75: Moderate reliability
-	0.75<0.9: Good reliability
-	â‰¥0.9: Excellent reliability

```{r echo=FALSE, include=FALSE}
# Create M1-3 matrices by age category, device, and measurement type

# -- Rad-G
## Rad-G, Age Cat 1
df_radg_cat1_temp <- df_radg_cat1 %>% select(colnames(df_radg_cat1[grepl("+index_temp", names(df_radg_cat1))]))
df_radg_cat1_o2 <- df_radg_cat1 %>% select(colnames(df_radg_cat1[grepl("+index_o2", names(df_radg_cat1))]))
df_radg_cat1_pi <- df_radg_cat1 %>% select(colnames(df_radg_cat1[grepl("+index_pi", names(df_radg_cat1))]))
df_radg_cat1_pr <- df_radg_cat1 %>% select(colnames(df_radg_cat1[grepl("+index_pr", names(df_radg_cat1))]))
df_radg_cat1_rr <- df_radg_cat1 %>% select(colnames(df_radg_cat1[grepl("+index_rr", names(df_radg_cat1))]))
## Rad-G, Age Cat 2
df_radg_cat2_temp <- df_radg_cat2 %>% select(colnames(df_radg_cat2[grepl("+index_temp", names(df_radg_cat2))]))
df_radg_cat2_o2 <- df_radg_cat2 %>% select(colnames(df_radg_cat2[grepl("+index_o2", names(df_radg_cat2))]))
df_radg_cat2_pi <- df_radg_cat2 %>% select(colnames(df_radg_cat2[grepl("+index_pi", names(df_radg_cat2))]))
df_radg_cat2_pr <- df_radg_cat2 %>% select(colnames(df_radg_cat2[grepl("+index_pr", names(df_radg_cat2))]))
df_radg_cat2_rr <- df_radg_cat2 %>% select(colnames(df_radg_cat2[grepl("+index_rr", names(df_radg_cat2))]))
## Rad-G, Age Cat 3
df_radg_cat3_temp <- df_radg_cat3 %>% select(colnames(df_radg_cat3[grepl("+index_temp", names(df_radg_cat3))]))
df_radg_cat3_o2 <- df_radg_cat3 %>% select(colnames(df_radg_cat3[grepl("+index_o2", names(df_radg_cat3))]))
df_radg_cat3_pi <- df_radg_cat3 %>% select(colnames(df_radg_cat3[grepl("+index_pi", names(df_radg_cat3))]))
df_radg_cat3_pr <- df_radg_cat3 %>% select(colnames(df_radg_cat3[grepl("+index_pr", names(df_radg_cat3))]))
df_radg_cat3_rr <- df_radg_cat3 %>% select(colnames(df_radg_cat3[grepl("+index_rr", names(df_radg_cat3))]))

# -- Biolight
## Biolight, Age Cat 1
df_bio_cat1_o2 <- df_bio_cat1 %>% select(colnames(df_bio_cat1[grepl("+index_o2", names(df_bio_cat1))]))
df_bio_cat1_pr <- df_bio_cat1 %>% select(colnames(df_bio_cat1[grepl("+index_pr", names(df_bio_cat1))]))
df_bio_cat1_rr <- df_bio_cat1 %>% select(colnames(df_bio_cat1[grepl("+index_rr", names(df_bio_cat1))]))
## Biolight, Age Cat 2
df_bio_cat2_o2 <- df_bio_cat2 %>% select(colnames(df_bio_cat2[grepl("+index_o2", names(df_bio_cat2))]))
df_bio_cat2_pr <- df_bio_cat2 %>% select(colnames(df_bio_cat2[grepl("+index_pr", names(df_bio_cat2))]))
df_bio_cat2_rr <- df_bio_cat2 %>% select(colnames(df_bio_cat2[grepl("+index_rr", names(df_bio_cat2))]))
## Biolight, Age Cat 3
df_bio_cat3_o2 <- df_bio_cat3 %>% select(colnames(df_bio_cat3[grepl("+index_o2", names(df_bio_cat3))]))
df_bio_cat3_pr <- df_bio_cat3 %>% select(colnames(df_bio_cat3[grepl("+index_pr", names(df_bio_cat3))]))
df_bio_cat3_rr <- df_bio_cat3 %>% select(colnames(df_bio_cat3[grepl("+index_rr", names(df_bio_cat3))]))

# -- NeoGuard
## NeoGuard, Age Cat 1
df_neo_cat1_temp <- df_neo_cat1 %>% select(colnames(df_neo_cat1[grepl("+index_temp", names(df_neo_cat1))]))
df_neo_cat1_o2 <- df_neo_cat1 %>% select(colnames(df_neo_cat1[grepl("+index_o2", names(df_neo_cat1))]))
df_neo_cat1_pr <- df_neo_cat1 %>% select(colnames(df_neo_cat1[grepl("+index_pr", names(df_neo_cat1))]))
df_neo_cat1_rr <- df_neo_cat1 %>% select(colnames(df_neo_cat1[grepl("+index_rr", names(df_neo_cat1))]))
## NeoGuard, Age Cat 2
df_neo_cat2_temp <- df_neo_cat2 %>% select(colnames(df_neo_cat2[grepl("+index_temp", names(df_neo_cat2))]))
df_neo_cat2_o2 <- df_neo_cat2 %>% select(colnames(df_neo_cat2[grepl("+index_o2", names(df_neo_cat2))]))
df_neo_cat2_pr <- df_neo_cat2 %>% select(colnames(df_neo_cat2[grepl("+index_pr", names(df_neo_cat2))]))
df_neo_cat2_rr <- df_neo_cat2 %>% select(colnames(df_neo_cat2[grepl("+index_rr", names(df_neo_cat2))]))
## NeoGuard, Age Cat 3
df_neo_cat3_temp <- df_neo_cat3 %>% select(colnames(df_neo_cat3[grepl("+index_temp", names(df_neo_cat3))]))
df_neo_cat3_o2 <- df_neo_cat3 %>% select(colnames(df_neo_cat3[grepl("+index_o2", names(df_neo_cat3))]))
df_neo_cat3_pr <- df_neo_cat3 %>% select(colnames(df_neo_cat3[grepl("+index_pr", names(df_neo_cat3))]))
df_neo_cat3_rr <- df_neo_cat3 %>% select(colnames(df_neo_cat3[grepl("+index_rr", names(df_neo_cat3))]))

# -- Scanbo
## Scanbo, Age Cat 3
df_scan_cat3_temp <- df_scan_cat3 %>% select(colnames(df_scan_cat3[grepl("+index_temp", names(df_scan_cat3))]))
df_scan_cat3_sp02 <- df_scan_cat3 %>% select(colnames(df_scan_cat3[grepl("+index_sp02", names(df_scan_cat3))]))
df_scan_cat3_o2 <- df_scan_cat3 %>% select(colnames(df_scan_cat3[grepl("+index_o2", names(df_scan_cat3))]))
df_scan_cat3_pr <- df_scan_cat3 %>% select(colnames(df_scan_cat3[grepl("+index_pr", names(df_scan_cat3))]))
df_scan_cat3_rr <- df_scan_cat3 %>% select(colnames(df_scan_cat3[grepl("+index_rr", names(df_scan_cat3))]))

# -- Onyx
## Onyx, Age Cat 3
df_onyx_cat3_o2 <- df_onyx_cat3 %>% select(colnames(df_onyx_cat3[grepl("+index_o2", names(df_onyx_cat3))]))
df_onyx_cat3_pr <- df_onyx_cat3 %>% select(colnames(df_onyx_cat3[grepl("+index_pr", names(df_onyx_cat3))]))
df_onyx_cat3_rr <- df_onyx_cat3 %>% select(colnames(df_onyx_cat3[grepl("+index_rr", names(df_onyx_cat3))]))
```

```{r echo=FALSE, include=FALSE}
# Create ICC objects for each age category, device, and measurement type

# Rad-G ICC objects
## Age Cat 1
icc_radg_cat1_temp <- icc(df_radg_cat1_temp, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat1_o2 <- icc(df_radg_cat1_o2, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat1_pi <- icc(df_radg_cat1_pi, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat1_pr <- icc(df_radg_cat1_pr, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat1_rr <- icc(df_radg_cat1_rr, model = "twoway", type = "agreement", unit = "single")
## Age Cat 2
icc_radg_cat2_temp <- icc(df_radg_cat2_temp, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat2_o2 <- icc(df_radg_cat2_o2, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat2_pi <- icc(df_radg_cat2_pi, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat2_pr <- icc(df_radg_cat2_pr, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat2_rr <- icc(df_radg_cat2_rr, model = "twoway", type = "agreement", unit = "single")
## Age Cat 3
icc_radg_cat3_temp <- icc(df_radg_cat3_temp, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat3_o2 <- icc(df_radg_cat3_o2, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat3_pi <- icc(df_radg_cat3_pi, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat3_pr <- icc(df_radg_cat3_pr, model = "twoway", type = "agreement", unit = "single")
icc_radg_cat3_rr <- icc(df_radg_cat3_rr, model = "twoway", type = "agreement", unit = "single")

# Biolight ICC objects
## Age Cat 1
icc_bio_cat1_o2 <- icc(df_bio_cat1_o2, model = "twoway", type = "agreement", unit = "single")
icc_bio_cat1_pr <- icc(df_bio_cat1_pr, model = "twoway", type = "agreement", unit = "single")
icc_bio_cat1_rr <- icc(df_bio_cat1_rr, model = "twoway", type = "agreement", unit = "single")
## Age Cat 2
icc_bio_cat2_o2 <- icc(df_bio_cat2_o2, model = "twoway", type = "agreement", unit = "single")
icc_bio_cat2_pr <- icc(df_bio_cat2_pr, model = "twoway", type = "agreement", unit = "single")
icc_bio_cat2_rr <- icc(df_bio_cat2_rr, model = "twoway", type = "agreement", unit = "single")
## Age Cat 3
icc_bio_cat3_o2 <- icc(df_bio_cat3_o2, model = "twoway", type = "agreement", unit = "single")
icc_bio_cat3_pr <- icc(df_bio_cat3_pr, model = "twoway", type = "agreement", unit = "single")
icc_bio_cat3_rr <- icc(df_bio_cat3_rr, model = "twoway", type = "agreement", unit = "single")

# NeoGuard ICC objects
## Age Cat 1
icc_neo_cat1_temp <- icc(df_neo_cat1_temp, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat1_o2 <- icc(df_neo_cat1_o2, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat1_pr <- icc(df_neo_cat1_pr, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat1_rr <- icc(df_neo_cat1_rr, model = "twoway", type = "agreement", unit = "single")
## Age Cat 2
icc_neo_cat2_temp <- icc(df_neo_cat2_temp, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat2_o2 <- icc(df_neo_cat2_o2, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat2_pr <- icc(df_neo_cat2_pr, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat2_rr <- icc(df_neo_cat2_rr, model = "twoway", type = "agreement", unit = "single")
## Age Cat 3
icc_neo_cat3_temp <- icc(df_neo_cat3_temp, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat3_o2 <- icc(df_neo_cat3_o2, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat3_pr <- icc(df_neo_cat3_pr, model = "twoway", type = "agreement", unit = "single")
icc_neo_cat3_rr <- icc(df_neo_cat3_rr, model = "twoway", type = "agreement", unit = "single")

# Scanbo ICC objects
## Age Cat 3
icc_scan_cat3_temp <- icc(df_scan_cat3_temp, model = "twoway", type = "agreement", unit = "single")
icc_scan_cat3_sp02 <- icc(df_scan_cat3_sp02, model = "twoway", type = "agreement", unit = "single")
icc_scan_cat3_o2 <- icc(df_scan_cat3_o2, model = "twoway", type = "agreement", unit = "single")
icc_scan_cat3_pr <- icc(df_scan_cat3_pr, model = "twoway", type = "agreement", unit = "single")
icc_scan_cat3_rr <- icc(df_scan_cat3_rr, model = "twoway", type = "agreement", unit = "single")

# Onyx ICC objects
## Age Cat 3
icc_onyx_cat3_o2 <- icc(df_onyx_cat3_o2, model = "twoway", type = "agreement", unit = "single")
icc_onyx_cat3_pr <- icc(df_onyx_cat3_pr, model = "twoway", type = "agreement", unit = "single")
icc_onyx_cat3_rr <- icc(df_onyx_cat3_rr, model = "twoway", type = "agreement", unit = "single")
```

```{r echo=FALSE, include=FALSE}
# Build a table of ICC [95%CI] for each age category
# $value = icc point estimate; $lbound = lower bound of CI; $ubound = upper bound of CI

## Age Cat 1
out1 <- data.frame(cc = c("", "", "", "", "", "", "", "", "", ""),
                   radg = c(round(icc_radg_cat1_temp$value, 2), paste("(", round(icc_radg_cat1_temp$lbound, 2)," - ", round(icc_radg_cat1_temp$ubound, 2),")", sep = ""), 
                            round(icc_radg_cat1_o2$value, 2), paste("(", round(icc_radg_cat1_o2$lbound, 2)," - ", round(icc_radg_cat1_o2$ubound, 2),")", sep = ""), 
                            round(icc_radg_cat1_pi$value, 2), paste("(", round(icc_radg_cat1_pi$lbound, 2)," - ", round(icc_radg_cat1_pi$ubound, 2), ")", sep = ""),
                            round(icc_radg_cat1_pr$value, 2), paste("(", round(icc_radg_cat1_pr$lbound, 2) ," - ", round(icc_radg_cat1_pr$ubound, 2) ,")", sep = ""),
                            round(icc_radg_cat1_rr$value, 2), paste("(", round(icc_radg_cat1_rr$lbound, 2)," - ", round(icc_radg_cat1_rr$ubound, 2),")", sep = "")), 
                   bio = c(NA, NA,
                           round(icc_bio_cat1_o2$value, 2), paste("(", round(icc_bio_cat1_o2$lbound, 2)," - ", round(icc_bio_cat1_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_bio_cat1_pr$value, 2), paste("(", round(icc_bio_cat1_pr$lbound, 2), " - ", round(icc_bio_cat1_pr$ubound, 2),")", sep = ""),
                           round(icc_bio_cat1_rr$value, 2), paste("(", round(icc_bio_cat1_rr$lbound, 2) ," - ", round(icc_bio_cat1_rr$ubound, 2),")", sep = "")),
                   neo = c(round(icc_neo_cat1_temp$value, 2), paste("(", round(icc_neo_cat1_temp$lbound, 2)," - ", round(icc_neo_cat1_temp$ubound, 2), ")", sep = ""),
                           round(icc_neo_cat1_o2$value, 2), paste("(", round(icc_neo_cat1_o2$lbound, 2), " - ", round(icc_neo_cat1_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_neo_cat1_pr$value, 2), paste("(", round(icc_neo_cat1_pr$lbound, 2), " - ", round(icc_neo_cat1_pr$ubound, 2),")", sep = ""),
                           round(icc_neo_cat1_rr$value, 2), paste("(", round(icc_neo_cat1_rr$lbound, 2), " - ", round(icc_neo_cat1_rr$ubound, 2), ")", sep = "")))
icc_t1 <- kable(out1, col.names = c("","Rad-G Temp (Masimo)", "M800 (Biolight)", "NeoGuard (Neopenda)")) %>% 
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center") %>%
  pack_rows("Temperature", 1, 2) %>%
  pack_rows("Oxygen", 3, 4) %>%
  pack_rows("Profusion Index", 5, 6) %>%
  pack_rows("Pulse Rate", 7, 8) %>%
  pack_rows("Respiratory Rate", 9, 10) %>%
  add_header_above(c(" ", "Intraclass correlation coefficient for clinical measures across devices for participantss aged 0-1 month (95%CI)" = 3))

# Age Cat 2
out2 <- data.frame(cc = c("", "", "", "", "", "", "", "", "", ""),
                   radg = c(round(icc_radg_cat2_temp$value, 2), paste("(", round(icc_radg_cat2_temp$lbound, 2)," - ", round(icc_radg_cat2_temp$ubound, 2),")", sep = ""), 
                            round(icc_radg_cat2_o2$value, 2), paste("(", round(icc_radg_cat2_o2$lbound, 2)," - ", round(icc_radg_cat2_o2$ubound, 2),")", sep = ""), 
                            round(icc_radg_cat2_pi$value, 2), paste("(", round(icc_radg_cat2_pi$lbound, 2)," - ", round(icc_radg_cat2_pi$ubound, 2), ")", sep = ""),
                            round(icc_radg_cat2_pr$value, 2), paste("(", round(icc_radg_cat2_pr$lbound, 2) ," - ", round(icc_radg_cat2_pr$ubound, 2) ,")", sep = ""),
                            round(icc_radg_cat2_rr$value, 2), paste("(", round(icc_radg_cat2_rr$lbound, 2)," - ", round(icc_radg_cat2_rr$ubound, 2),")", sep = "")), 
                   bio = c(NA, NA,
                           round(icc_bio_cat2_o2$value, 2), paste("(", round(icc_bio_cat2_o2$lbound, 2)," - ", round(icc_bio_cat2_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_bio_cat2_pr$value, 2), paste("(", round(icc_bio_cat2_pr$lbound, 2), " - ", round(icc_bio_cat2_pr$ubound, 2),")", sep = ""),
                           round(icc_bio_cat2_rr$value, 2), paste("(", round(icc_bio_cat2_rr$lbound, 2) ," - ", round(icc_bio_cat2_rr$ubound, 2),")", sep = "")),
                   neo = c(round(icc_neo_cat2_temp$value, 2), paste("(", round(icc_neo_cat2_temp$lbound, 2)," - ", round(icc_neo_cat2_temp$ubound, 2), ")", sep = ""),
                           round(icc_neo_cat2_o2$value, 2), paste("(", round(icc_neo_cat2_o2$lbound, 2), " - ", round(icc_neo_cat2_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_neo_cat2_pr$value, 2), paste("(", round(icc_neo_cat2_pr$lbound, 2), " - ", round(icc_neo_cat2_pr$ubound, 2),")", sep = ""),
                           round(icc_neo_cat2_rr$value, 2), paste("(", round(icc_neo_cat2_rr$lbound, 2), " - ", round(icc_neo_cat2_rr$ubound, 2), ")", sep = "")))
icc_t2 <- kable(out2, col.names = c("","Rad-G Temp (Masimo)", "M800 (Biolight)", "NeoGuard (Neopenda)")) %>% 
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center") %>%
  pack_rows("Temperature", 1, 2) %>%
  pack_rows("Oxygen", 3, 4) %>%
  pack_rows("Profusion Index", 5, 6) %>%
  pack_rows("Pulse Rate", 7, 8) %>%
  pack_rows("Respiratory Rate", 9, 10) %>%
  add_header_above(c(" ", "Intraclass correlation coefficient for clinical measures across devices for participantss aged 2-11 months (95%CI)" = 3))

# Age Cat 3
out3 <- data.frame(cc = c("", "", "", "", "", "", "", "", "", ""),
                   radg = c(round(icc_radg_cat3_temp$value, 2), paste("(", round(icc_radg_cat3_temp$lbound, 2)," - ", round(icc_radg_cat3_temp$ubound, 2),")", sep = ""), 
                            round(icc_radg_cat3_o2$value, 2), paste("(", round(icc_radg_cat3_o2$lbound, 2)," - ", round(icc_radg_cat3_o2$ubound, 2),")", sep = ""), 
                            round(icc_radg_cat3_pi$value, 2), paste("(", round(icc_radg_cat3_pi$lbound, 2)," - ", round(icc_radg_cat3_pi$ubound, 2), ")", sep = ""),
                            round(icc_radg_cat3_pr$value, 2), paste("(", round(icc_radg_cat3_pr$lbound, 2) ," - ", round(icc_radg_cat3_pr$ubound, 2) ,")", sep = ""),
                            round(icc_radg_cat3_rr$value, 2), paste("(", round(icc_radg_cat3_rr$lbound, 2)," - ", round(icc_radg_cat3_rr$ubound, 2),")", sep = "")), 
                   bio = c(NA, NA,
                           round(icc_bio_cat3_o2$value, 2), paste("(", round(icc_bio_cat3_o2$lbound, 2)," - ", round(icc_bio_cat3_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_bio_cat3_pr$value, 2), paste("(", round(icc_bio_cat3_pr$lbound, 2), " - ", round(icc_bio_cat3_pr$ubound, 2),")", sep = ""),
                           round(icc_bio_cat3_rr$value, 2), paste("(", round(icc_bio_cat3_rr$lbound, 2) ," - ", round(icc_bio_cat3_rr$ubound, 2),")", sep = "")),
                   scan = c(round(icc_scan_cat3_temp$value, 2), paste("(", round(icc_scan_cat3_temp$lbound, 2)," - ", round(icc_scan_cat3_temp$ubound, 2), ")", sep = ""),
                           round(icc_scan_cat3_o2$value, 2), paste("(", round(icc_scan_cat3_o2$lbound, 2), " - ", round(icc_scan_cat3_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_scan_cat3_pr$value, 2), paste("(", round(icc_scan_cat3_pr$lbound, 2), " - ", round(icc_scan_cat3_pr$ubound, 2),")", sep = ""),
                           round(icc_scan_cat3_rr$value, 2), paste("(", round(icc_scan_cat3_rr$lbound, 2), " - ", round(icc_scan_cat3_rr$ubound, 2), ")", sep = "")),
                   onyx = c(NA, NA,
                           round(icc_onyx_cat3_o2$value, 2), paste("(", round(icc_onyx_cat3_o2$lbound, 2)," - ", round(icc_onyx_cat3_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_onyx_cat3_pr$value, 2), paste("(", round(icc_onyx_cat3_pr$lbound, 2), " - ", round(icc_onyx_cat3_pr$ubound, 2),")", sep = ""),
                           round(icc_onyx_cat3_rr$value, 2), paste("(", round(icc_onyx_cat3_rr$lbound, 2) ," - ", round(icc_onyx_cat3_rr$ubound, 2),")", sep = "")),
                   neo = c(round(icc_neo_cat3_temp$value, 2), paste("(", round(icc_neo_cat3_temp$lbound, 2)," - ", round(icc_neo_cat3_temp$ubound, 2), ")", sep = ""),
                           round(icc_neo_cat3_o2$value, 2), paste("(", round(icc_neo_cat3_o2$lbound, 2), " - ", round(icc_neo_cat3_o2$ubound, 2), ")", sep = ""),
                           NA, NA,
                           round(icc_neo_cat3_pr$value, 2), paste("(", round(icc_neo_cat3_pr$lbound, 2), " - ", round(icc_neo_cat3_pr$ubound, 2),")", sep = ""),
                           round(icc_neo_cat3_rr$value, 2), paste("(", round(icc_neo_cat3_rr$lbound, 2), " - ", round(icc_neo_cat3_rr$ubound, 2), ")", sep = "")))
icc_t3 <- kable(out3, col.names = c("","Rad-G Temp (Masimo)", "M800 (Biolight)", "Scanbo v8 (Scanbo)", "Onyx PO+RR (Nonin)", "NeoGuard (Neopenda)")) %>% 
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center") %>%
  pack_rows("Temperature", 1, 2) %>%
  pack_rows("Oxygen", 3, 4) %>%
  pack_rows("Profusion Index", 5, 6) %>%
  pack_rows("Pulse Rate", 7, 8) %>%
  pack_rows("Respiratory Rate", 9, 10) %>%
  add_header_above(c(" ", "Intraclass correlation coefficient for clinical measures across devices for participantss aged 12-59 months (95%CI)" = 5))
```

## Table 3a
`r icc_t1`
## Table 3b
`r icc_t2`
## Table 3c
`r icc_t3`

# Section 5: Confusion Matrices {.tabset}
Samwel
5 & 6 should be done by same person
```{r echo=FALSE, include=FALSE}
# key functions: irr::agree, addmargins(table()), prop.table
```

## Rad-G Temp (Masimo)


## m800 (Biolight)


## NeoGuard (Neopenda)


## Onyx PO+RR (Nonin)


## Scanbo v8 (Scanbo)

# Section 6: Percent Agreement {.tabset}
Samwel
